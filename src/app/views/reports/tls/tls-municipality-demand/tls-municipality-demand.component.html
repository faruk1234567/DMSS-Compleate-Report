<div class="container-fluid px-3 px-md-4">
  <div class="card shadow-lg mb-4 rounded-3 border-0">
    <div class="card-header bg-dark text-white py-3 px-4 d-flex align-items-center justify-content-between rounded-top-3">
      <h2 class="h5 mb-0 fw-bold"><i class="bi bi-file-earmark-text-fill me-2"></i>ট্রেড লাইসেন্স চাহিদার রিপোর্ট</h2>
    </div>
    <div class="card-body p-4">
      <form (ngSubmit)="gettlsDemandReport(reportForm)" #reportForm="ngForm" class="row g-4 align-items-end">
        <div class="col-12 col-sm-6 col-md-4"> <label for="municipalityId" class="form-label mb-2 fw-semibold text-dark">পৌরসভা আইডি:</label>
          <input type="number" class="form-control form-control-lg rounded-pill border-dark"
                     id="municipalityId" name="municipalityId"
                     [(ngModel)]="formData.municipalityId" required />
          <div *ngIf="reportForm.submitted && !formData.municipalityId" class="text-danger small mt-1">
            পৌরসভা আইডি প্রয়োজন।
          </div>
        </div>

        <div class="col-12 col-sm-6 col-md-4"> <label for="endDate" class="form-label mb-2 fw-semibold text-dark">চাহিদা তারিখ:</label>
          <div class="input-group input-group-lg rounded-pill overflow-hidden">
            <input type="date" class="form-control border-dark border-end-0"
                     id="endDate" name="endDate"
                     [(ngModel)]="formData.endDate" required />
            <span class="input-group-text bg-white border-dark border-start-0 text-primary">
              <i class="bi bi-calendar-date fs-5"></i>
            </span>
          </div>
          <div *ngIf="reportForm.submitted && !formData.endDate" class="text-danger small mt-1">
            চাহিদা তারিখ প্রয়োজন।
          </div>
        </div>

        <div class="col-12 col-sm-6 col-md-4 d-flex align-items-end"> <button type="submit"
                  class="btn btn-dark btn-lg flex-grow-1 shadow-sm rounded-pill"
                  [disabled]="!reportForm.form.valid || isLoading">
            <span *ngIf="!isLoading">
              <i class="bi bi-search me-2"></i> রিপোর্ট দেখুন
            </span>
            <span *ngIf="isLoading">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              লোডিং...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div *ngIf="isLoading" class="d-flex justify-content-center align-items-center my-5" style="height: 150px;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="ms-3 h4 text-muted">রিপোর্ট লোড হচ্ছে, অনুগ্রহ করে অপেক্ষা করুন...</p>
  </div>
  
  <div *ngIf="errorMessage" class="alert alert-danger text-center mt-3" role="alert">
    {{ errorMessage }}
  </div>

  <div class="card shadow-sm mb-4" *ngIf="showReport && !isLoading">
    <div class="card-header bg-info text-white py-2 custom-card-header d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">রিপোর্টের তথ্য</h2>
      <div class="d-flex align-items-center">
        <div class="me-3 text-white">
          <p class="mb-0 fw-bold">মোট লাইসেন্স: {{ getTotalLicenses() }}</p>
          <p class="mb-0 fw-bold">মোট টাকা: {{ getTotalAmountSum() }}</p>
        </div>
        <button class="btn btn-success me-2" (click)="exportToExcel()" [disabled]="reportData.length === 0 || isLoadingExcel">
          <span *ngIf="!isLoadingExcel">
            <i class="bi bi-file-earmark-excel-fill me-1"></i> এক্সেল ডাউনলোড
          </span>
          <span *ngIf="isLoadingExcel">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            ডাউনলোড হচ্ছে...
          </span>
        </button>
        <button class="btn btn-primary" (click)="printReport()" [disabled]="reportData.length === 0">
          <i class="bi bi-printer-fill me-1"></i> প্রিন্ট
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive table-container-scroll">
        <table class="table table-striped table-bordered table-hover mb-0">
          <thead class="sticky-top-table-header">
             <tr>
              <th rowspan="2">ক্রঃ নং</th>
              <th rowspan="2">মোবাইল নম্বর</th>
              <th rowspan="2">ট্রানজেকশন ডেট</th>
              <th rowspan="2">লাইসেন্স নম্বর</th>
              <th rowspan="2">টাইটেল</th>
              <th rowspan="2">NID</th>
              <th rowspan="2">অ্যামাউন্ট</th>
              <!-- <th rowspan="2">সাইনবোর্ড টাইপ</th> -->
              <th colspan="4">সাইন বোর্ড বিস্তারিত</th> </tr>
            <tr>
              <th>টাইপ</th>
              <th>রেট/ফিট</th>
              <th>দৈর্ঘ্য</th>
              <th>প্রস্থ</th>
            </tr>
          </thead>
          <tbody>
           <ng-container *ngIf="reportData && reportData.length > 0; else noData">
    <tr *ngFor="let item of reportData; let i = index"> <td>{{ (page - 1) * pageSize + i + 1 }}</td> <td>{{ item.mobileno }}</td>
      <td>{{ item.transactiondate | date: 'yyyy-MM-dd HH:mm:ss' }}</td>
      <td>{{ item.licenseno }}</td>
      <td>{{ item.title }}</td>
      <td>{{ item.nationalid }}</td>
      <td>{{ item.amount }}</td>
      <td>{{ item.signboardtype }}</td>
      <td>{{ item.signboardpersft }}</td>
      <td>{{ item.height }}</td>
      <td>{{ item.width }}</td>
    </tr>
            </ng-container>
            <ng-template #noData>
              <tr>
                <td colspan="11" class="text-center p-4 text-danger">
                  কোনো ডেটা পাওয়া যায়নি। ডেটা দেখতে উপরের ফর্ম পূরণ করে "রিপোর্ট দেখুন" বাটনে ক্লিক করুন।
                </td>
              </tr>
            </ng-template>
          </tbody>
        </table>
      </div>
    </div>
    <div *ngIf="showReport && totalPages > 1" class="pagination-controls">
      <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="page === 1">
            <a class="page-link" (click)="prevPage()" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>

          <li class="page-item" *ngFor="let p of getPages()" [class.active]="p === page">
            <a class="page-link" (click)="goToPage(p)">{{ p }}</a>
          </li>

          <li class="page-item" [class.disabled]="page === totalPages">
            <a class="page-link" (click)="nextPage()" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>

      <div class="text-center mt-2">
        Showing {{ (page - 1) * pageSize + 1 }} to {{ Math.min(page * pageSize, totalItems) }} of {{ totalItems }} entries
      </div>
    </div>
  </div>
</div>